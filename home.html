<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Panorama Kitchens</title>
<style>
  html, body { 
    margin: 0; 
    height: 100%; 
    background: #000; 
    font-family: Arial, sans-serif;
  }
  #viewer { 
    width: 100%; 
    height: 100%; 
    display: block; 
    cursor: grab;
  }
  #viewer:active {
    cursor: grabbing;
  }
  .logo {
    position: fixed;
    top: 12px;
    left: 12px;
    z-index: 10;
    background: rgba(0,0,0,0.7);
    padding: 10px;
    border-radius: 8px;
    backdrop-filter: blur(5px);
  }
  .logo img {
    height: 60px;
  }
  .controls-panel {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    left: 12px;
    z-index: 10;
    background: rgba(0,0,0,0.7);
    padding: 15px;
    border-radius: 8px;
    backdrop-filter: blur(5px);
    display: flex;
    flex-direction: column;
    gap: 10px;
    opacity: 0.3;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  .controls-panel:hover {
    opacity: 1;
    transform: translateY(-50%) scale(1.05);
  }
  .switch-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #fff;
    padding: 12px 16px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
    min-width: 180px;
  }
  .switch-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  }
  .zoom-controls {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .zoom-btn {
    background: rgba(255,255,255,0.3);
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 20px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .zoom-btn:hover {
    background: rgba(255,255,255,0.5);
    transform: scale(1.1);
  }
  .zoom-slider {
    writing-mode: bt-lr; /* IE */
    writing-mode: vertical-lr; /* Standard */
    width: 20px;
    height: 100px;
    margin: 10px auto;
    background: transparent;
  }
  .reset-btn {
    background: rgba(255,193,7,0.9);
    color: #000;
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
  }
  .reset-btn:hover {
    background: rgb(255,193,7);
    transform: translateY(-1px);
  }
  .zoom-info {
    color: #fff;
    font-size: 12px;
    text-align: center;
    margin-top: 5px;
    background: rgba(0,0,0,0.5);
    padding: 4px 8px;
    border-radius: 4px;
  }
  .error {
    color: #fff;
    padding: 20px;
  }
  
  @media (max-width: 768px) {
    .controls-panel {
      left: 50%;
      transform: translateX(-50%);
      bottom: 20px;
      top: auto;
      flex-direction: row;
      justify-content: center;
      padding: 10px;
      opacity: 0.3;
    }
    .controls-panel:hover {
      opacity: 1;
      transform: translateX(-50%) scale(1.05);
    }
    .zoom-slider {
      writing-mode: horizontal-tb;
      width: 100px;
      height: 20px;
    }
    .switch-btn {
      min-width: auto;
      padding: 10px 12px;
      font-size: 12px;
    }
  }
</style>
</head>
<body>
<div class="logo">
  <img src="logo.png" alt="Kitchens Logo">
</div>

<div class="controls-panel">
  <button class="switch-btn" onclick="switchKitchen()">انتقل للمطبخ الآخر</button>
  
  <div class="zoom-controls">
    <button class="zoom-btn" onclick="zoomIn()" title="تكبير">+</button>
    <input type="range" class="zoom-slider" min="0.5" max="3" step="0.1" value="1" oninput="setZoom(this.value)" title="مستوى التكبير">
    <button class="zoom-btn" onclick="zoomOut()" title="تصغير">−</button>
    <button class="reset-btn" onclick="resetView()" title="إعادة تعيين">إعادة ضبط</button>
  </div>
  
  <div class="zoom-info" id="zoomInfo">زوم: 100%</div>
</div>

<canvas id="viewer"></canvas>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
let scene, camera, renderer, controls;
let currentKitchen = 1;
let currentZoom = 1;
let targetFOV = 75;
const initialFOV = 75;
const minFOV = 25; // أقصى تكبير
const maxFOV = 110; // أقصى تصغير

const kitchens = {
  1: ['show_r.jpg','show_l.jpg','show_u.jpg','show_d.jpg','show_f.jpg','show_b.jpg'],
  2: ['k2_r.jpg','k2_l.jpg','k2_u.jpg','k2_d.jpg','k2_f.jpg','k2_b.jpg']
};

init();
loadKitchen(currentKitchen);

function init(){
  renderer = new THREE.WebGLRenderer({
    canvas: document.getElementById('viewer'), 
    antialias: true
  });
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setPixelRatio(window.devicePixelRatio);
  renderer.outputEncoding = THREE.sRGBEncoding;
  
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(initialFOV, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0, 0, 0.1);
  
  // إنشاء controls مخصص بدلاً من OrbitControls
  setupCustomControls();
  
  // إضافة دعم اللمس والماوس للزوم
  setupZoomControls();
  
  window.addEventListener('resize', onWindowResize);
  animate();
}

function setupCustomControls() {
  let isMouseDown = false;
  let mouseX = 0, mouseY = 0;
  let targetRotationX = 0, targetRotationY = 0;
  let currentRotationX = 0, currentRotationY = 0;
  
  const canvas = document.getElementById('viewer');
  
  // Mouse events
  canvas.addEventListener('mousedown', (event) => {
    isMouseDown = true;
    mouseX = event.clientX;
    mouseY = event.clientY;
    canvas.style.cursor = 'grabbing';
  });
  
  canvas.addEventListener('mousemove', (event) => {
    if (!isMouseDown) return;
    
    const deltaX = event.clientX - mouseX;
    const deltaY = event.clientY - mouseY;
    
    targetRotationY += deltaX * 0.005;
    targetRotationX += deltaY * 0.005;
    
    // تقييد الدوران العمودي
    targetRotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, targetRotationX));
    
    mouseX = event.clientX;
    mouseY = event.clientY;
  });
  
  canvas.addEventListener('mouseup', () => {
    isMouseDown = false;
    canvas.style.cursor = 'grab';
  });
  
  // Touch events للأجهزة المحمولة
  let lastTouchX = 0, lastTouchY = 0;
  
  canvas.addEventListener('touchstart', (event) => {
    event.preventDefault();
    if (event.touches.length === 1) {
      lastTouchX = event.touches[0].clientX;
      lastTouchY = event.touches[0].clientY;
    }
  });
  
  canvas.addEventListener('touchmove', (event) => {
    event.preventDefault();
    if (event.touches.length === 1) {
      const touch = event.touches[0];
      const deltaX = touch.clientX - lastTouchX;
      const deltaY = touch.clientY - lastTouchY;
      
      targetRotationY += deltaX * 0.005;
      targetRotationX += deltaY * 0.005;
      
      targetRotationX = Math.max(-Math.PI/2, Math.min(Math.PI/2, targetRotationX));
      
      lastTouchX = touch.clientX;
      lastTouchY = touch.clientY;
    }
  });
  
  // تحديث دوران الكاميرا بسلاسة
  function updateCameraRotation() {
    currentRotationX += (targetRotationX - currentRotationX) * 0.1;
    currentRotationY += (targetRotationY - currentRotationY) * 0.1;
    
    camera.rotation.x = currentRotationX;
    camera.rotation.y = currentRotationY;
  }
  
  // إضافة updateCameraRotation للحلقة الرئيسية
  const originalAnimate = animate;
  animate = function() {
    updateCameraRotation();
    originalAnimate();
  };
}

function setupZoomControls() {
  const canvas = document.getElementById('viewer');
  
  // دعم عجلة الماوس
  canvas.addEventListener('wheel', (event) => {
    event.preventDefault();
    const zoomSpeed = 0.1;
    const delta = event.deltaY > 0 ? zoomSpeed : -zoomSpeed;
    
    targetFOV += delta * 10;
    targetFOV = Math.max(minFOV, Math.min(maxFOV, targetFOV));
    
    updateZoomSlider();
  });
  
  // دعم الزوم باللمس (pinch to zoom)
  let lastTouchDistance = 0;
  
  canvas.addEventListener('touchstart', (event) => {
    if (event.touches.length === 2) {
      const touch1 = event.touches[0];
      const touch2 = event.touches[1];
      lastTouchDistance = Math.hypot(
        touch2.clientX - touch1.clientX,
        touch2.clientY - touch1.clientY
      );
    }
  });
  
  canvas.addEventListener('touchmove', (event) => {
    if (event.touches.length === 2) {
      event.preventDefault();
      const touch1 = event.touches[0];
      const touch2 = event.touches[1];
      const currentDistance = Math.hypot(
        touch2.clientX - touch1.clientX,
        touch2.clientY - touch1.clientY
      );
      
      const deltaDistance = currentDistance - lastTouchDistance;
      const zoomFactor = deltaDistance * 0.1;
      
      targetFOV -= zoomFactor;
      targetFOV = Math.max(minFOV, Math.min(maxFOV, targetFOV));
      
      lastTouchDistance = currentDistance;
      updateZoomSlider();
    }
  });
}

function loadKitchen(num){
  const loader = new THREE.CubeTextureLoader();
  loader.setPath('./');
  
  // محاولة تحميل الصور، وفي حالة الفشل استخدام ألوان افتراضية
  try {
    const cubeTex = loader.load(
      kitchens[num],
      function(texture) {
        texture.encoding = THREE.sRGBEncoding;
        scene.background = texture;
      },
      undefined,
      function(error) {
        console.log('فشل في تحميل صور المطبخ، استخدام خلفية افتراضية');
        // إنشاء خلفية بلون متدرج كبديل
        createFallbackBackground(num);
      }
    );
  } catch(error) {
    createFallbackBackground(num);
  }
}

function createFallbackBackground(kitchenNum) {
  const colors = kitchenNum === 1 ? 
    ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', '#DDA0DD'] :
    ['#6C5CE7', '#A29BFE', '#FD79A8', '#FDCB6E', '#6C5CE7', '#74B9FF'];
  
  const materials = colors.map(color => new THREE.MeshBasicMaterial({color: color}));
  const geometry = new THREE.BoxGeometry(10, 10, 10);
  const cube = new THREE.Mesh(geometry, materials);
  
  // إزالة المكعب السابق إن وجد
  const existingCube = scene.getObjectByName('fallbackCube');
  if (existingCube) scene.remove(existingCube);
  
  cube.name = 'fallbackCube';
  cube.material.side = THREE.BackSide; // عرض الجهة الداخلية
  scene.add(cube);
}

function switchKitchen(){
  currentKitchen = (currentKitchen === 1) ? 2 : 1;
  loadKitchen(currentKitchen);
}

function zoomIn() {
  targetFOV = Math.max(minFOV, targetFOV - 5);
  updateZoomSlider();
}

function zoomOut() {
  targetFOV = Math.min(maxFOV, targetFOV + 5);
  updateZoomSlider();
}

function setZoom(value) {
  currentZoom = parseFloat(value);
  targetFOV = initialFOV / currentZoom;
  targetFOV = Math.max(minFOV, Math.min(maxFOV, targetFOV));
  updateZoomInfo();
}

function resetView() {
  targetFOV = initialFOV;
  currentZoom = 1;
  
  // إعادة ضبط دوران الكاميرا
  camera.rotation.set(0, 0, 0);
  camera.position.set(0, 0, 0.1);
  
  updateZoomSlider();
}

function updateZoomSlider() {
  currentZoom = initialFOV / targetFOV;
  const slider = document.querySelector('.zoom-slider');
  if (slider) {
    slider.value = currentZoom;
  }
  updateZoomInfo();
}

function updateZoomInfo() {
  const zoomInfo = document.getElementById('zoomInfo');
  if (zoomInfo) {
    zoomInfo.textContent = `زوم: ${Math.round(currentZoom * 100)}%`;
  }
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate(){
  requestAnimationFrame(animate);
  
  // تطبيق الزوم بسلاسة
  if (Math.abs(camera.fov - targetFOV) > 0.1) {
    camera.fov += (targetFOV - camera.fov) * 0.1;
    camera.updateProjectionMatrix();
  }
  
  renderer.render(scene, camera);
}

// إضافة اختصارات لوحة المفاتيح
document.addEventListener('keydown', (event) => {
  switch(event.key) {
    case '+':
    case '=':
      zoomIn();
      break;
    case '-':
      zoomOut();
      break;
    case 'r':
    case 'R':
      resetView();
      break;
    case ' ':
      event.preventDefault();
      switchKitchen();
      break;
  }
});

console.log('تم تحميل البانوراما بنجاح! استخدم الماوس أو اللمس للتنقل، وعجلة الماوس أو الأزرار للتكبير');
</script>
</body>
</html>
